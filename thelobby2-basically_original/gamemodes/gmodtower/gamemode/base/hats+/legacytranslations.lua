module("Hats", package.seeall )

LegacyTranslation = {
	[1] = {
		hash = { old = 54333, new = 54333 },
		unique_name = { old = "jasonmask", new = "jasonmask" },
		id = { old = 79, new = 31 },
	},
	[2] = {
		hash = { old = 4299, new = 16790 },
		unique_name = { old = "rubikscube", new = "rubikcubehat" },
		id = { old = 47, new = 41 },
	},
	[3] = {
		hash = { old = 22449, new = 22449 },
		unique_name = { old = "starglasseshat", new = "starglasseshat" },
		id = { old = 24, new = 23 },
	},
	[4] = {
		hash = { old = 1332, new = 1460 },
		unique_name = { old = "pilgramhat", new = "pilgrimhat" },
		id = { old = 17, new = 40 },
	},
	[5] = {
		hash = { old = 47311, new = 47311 },
		unique_name = { old = "bomermanhat", new = "bomermanhat" },
		id = { old = 29, new = 28 },
	},
	[6] = {
		hash = { old = 11969, new = 11969 },
		unique_name = { old = "Monocle", new = "Monocle" },
		id = { old = 61, new = 62 },
	},
	[7] = {
		hash = { old = 28910, new = 28910 },
		unique_name = { old = "toetohat", new = "toetohat" },
		id = { old = 21, new = 20 },
	},
	[8] = {
		hash = { old = 27233, new = 8859 },
		unique_name = { old = "dpthomas", new = "daftpunkthomas" },
		id = { old = 52, new = 46 },
	},
	[9] = {
		hash = { old = 32398, new = 32398 },
		unique_name = { old = "RoundShades", new = "RoundShades" },
		id = { old = 60, new = 61 },
	},
	[10] = {
		hash = { old = 10881, new = 10881 },
		unique_name = { old = "snowgoggles", new = "snowgoggles" },
		id = { old = 30, new = 29 },
	},
	[11] = {
		hash = { old = 49689, new = 49689 },
		unique_name = { old = "cuboneskull", new = "cuboneskull" },
		id = { old = 31, new = 45 },
	},
	[12] = {
		hash = { old = 52105, new = 52105 },
		unique_name = { old = "aviatorhat", new = "aviatorhat" },
		id = { old = 22, new = 21 },
	},
	[13] = {
		hash = { old = 12859, new = 21675 },
		unique_name = { old = "deadmau", new = "Deadmau5" },
		id = { old = 53, new = 71 },
	},
	[14] = {
		hash = { old = 39171, new = 17122 },
		unique_name = { old = "hatfedorahat", new = "hatfedorahatindy" },
		id = { old = 2, new = 5 },
	},
	[15] = {
		hash = { old = 46163, new = 46163 },
		unique_name = { old = "BunnyEars", new = "BunnyEars" },
		id = { old = 66, new = 68 },
	},
	[16] = {
		hash = { old = 50973, new = 50973 },
		unique_name = { old = "kingboocrown", new = "kingboocrown" },
		id = { old = 27, new = 26 },
	},
	[17] = {
		hash = { old = 4425, new = 4425 },
		unique_name = { old = "CatEarsAlternative", new = "CatEarsAlternative" },
		id = { old = 67, new = 69 },
	},
	[18] = {
		hash = { old = 28118, new = 28142 },
		unique_name = { old = "luigicap", new = "luigihat" },
		id = { old = 44, new = 50 },
	},
	[19] = {
		hash = { old = 28062, new = 28062 },
		unique_name = { old = "santahat", new = "santahat" },
		id = { old = 19, new = 18 },
	},
	[20] = {
		hash = { old = 51975, new = 42759 },
		unique_name = { old = "catbeanie", new = "CatBeanie" },
		id = { old = 33, new = 66 },
	},
	[21] = {
		hash = { old = 36538, new = 36538 },
		unique_name = { old = "FrogBeanie", new = "FrogBeanie" },
		id = { old = 65, new = 67 },
	},
	[22] = {
		hash = { old = 6863, new = 65 },
		unique_name = { old = "klonoa", new = "klonoahat" },
		id = { old = 54, new = 49 },
	},
	[23] = {
		hash = { old = 51199, new = 51199 },
		unique_name = { old = "legoheadhat", new = "legoheadhat" },
		id = { old = 28, new = 27 },
	},
	[24] = {
		hash = { old = 23310, new = 27210 },
		unique_name = { old = "hatfairywings", new = "hatmidnasmask" },
		id = { old = 9, new = 9 },
	},
	[25] = {
		hash = { old = 30074, new = 30074 },
		unique_name = { old = "BearBeanie", new = "BearBeanie" },
		id = { old = 64, new = 65 },
	},
	[26] = {
		hash = { old = 47528, new = 47528 },
		unique_name = { old = "hatbirthdayhat", new = "hatbirthdayhat" },
		id = { old = 20, new = 19 },
	},
	[27] = {
		hash = { old = 52440, new = 52440 },
		unique_name = { old = "HeartHeadband", new = "HeartHeadband" },
		id = { old = 74, new = 77 },
	},
	[28] = {
		hash = { old = 22, new = 22 },
		unique_name = { old = "nightmarehat", new = "nightmarehat" },
		id = { old = 80, new = 32 },
	},
	[29] = {
		hash = { old = 28966, new = 28966 },
		unique_name = { old = "MaidHeadband", new = "MaidHeadband" },
		id = { old = 73, new = 76 },
	},
	[30] = {
		hash = { old = 22765, new = 22765 },
		unique_name = { old = "DuckTube", new = "DuckTube" },
		id = { old = 77, new = 80 },
	},
	[31] = {
		hash = { old = 12384, new = 12384 },
		unique_name = { old = "SantaHatAnimated", new = "SantaHatAnimated" },
		id = { old = 76, new = 79 },
	},
	[32] = {
		hash = { old = 5877, new = 5877 },
		unique_name = { old = "Shades", new = "Shades" },
		id = { old = 58, new = 59 },
	},
	[33] = {
		hash = { old = 30648, new = 30648 },
		unique_name = { old = "androssmaskhat", new = "androssmaskhat" },
		id = { old = 25, new = 24 },
	},
	[34] = {
		hash = { old = 27526, new = 53817 },
		unique_name = { old = "gmtophat", new = "gmodtophat" },
		id = { old = 42, new = 33 },
	},
	[35] = {
		hash = { old = 13902, new = 13902 },
		unique_name = { old = "redshat", new = "redshat" },
		id = { old = 32, new = 54 },
	},
	[36] = {
		hash = { old = 6070, new = 6070 },
		unique_name = { old = "SunHat", new = "SunHat" },
		id = { old = 72, new = 75 },
	},
	[37] = {
		hash = { old = 4633, new = 4633 },
		unique_name = { old = "StarHeadband", new = "StarHeadband" },
		id = { old = 75, new = 78 },
	},
	[38] = {
		hash = { old = 10894, new = 10894 },
		unique_name = { old = "HeadCap", new = "HeadCap" },
		id = { old = 70, new = 73 },
	},
	[39] = {
		hash = { old = 29180, new = 29180 },
		unique_name = { old = "FedoraAlternative", new = "FedoraAlternative" },
		id = { old = 69, new = 72 },
	},
	[40] = {
		hash = { old = 1369, new = 12694 },
		unique_name = { old = "rockethat", new = "teamrockethat" },
		id = { old = 39, new = 38 },
	},
	[41] = {
		hash = { old = 275, new = 275 },
		unique_name = { old = "nofacemask", new = "nofacemask" },
		id = { old = 38, new = 34 },
	},
	[42] = {
		hash = { old = 54027, new = 54027 },
		unique_name = { old = "peachcrown", new = "peachcrown" },
		id = { old = 56, new = 53 },
	},
	[43] = {
		hash = { old = 45966, new = 45966 },
		unique_name = { old = "CowboyHat", new = "CowboyHat" },
		id = { old = 68, new = 70 },
	},
	[44] = {
		hash = { old = 27867, new = 27867 },
		unique_name = { old = "AfroAlternative", new = "AfroAlternative" },
		id = { old = 63, new = 64 },
	},
	[45] = {
		hash = { old = 24617, new = 24617 },
		unique_name = { old = "Mustache", new = "Mustache" },
		id = { old = 62, new = 63 },
	},
	[46] = {
		hash = { old = 28190, new = 28190 },
		unique_name = { old = "samushat", new = "samushat" },
		id = { old = 26, new = 25 },
	},
	/*[47] = {
		hash = { old = 18929, new = 18929 },
		unique_name = { old = "baseballcapreveresed", new = "baseballcapreveresed" },
		id = { old = 37, new = 37 },
	},*/
	[48] = {
		hash = { old = 12957, new = 48752 },
		unique_name = { old = "batmask", new = "batmanmask" },
		id = { old = 43, new = 35 },
	},
	[49] = {
		hash = { old = 18175, new = 18175 },
		unique_name = { old = "ShutterShades", new = "ShutterShades" },
		id = { old = 59, new = 60 },
	},
	[50] = {
		hash = { old = 25182, new = 25182 },
		unique_name = { old = "Strawhat", new = "Strawhat" },
		id = { old = 71, new = 74 },
	},
	[51] = {
		hash = { old = 40183, new = 40183 },
		unique_name = { old = "hatkfcbucket", new = "hatkfcbucket" },
		id = { old = 18, new = 17 },
	},
	[52] = {
		hash = { old = 553, new = 19447 },
		unique_name = { old = "pepperhat", new = "generalpepperhat" },
		id = { old = 46, new = 47 },
	},
	/*[53] = {
		hash = { old = 40407, new = 40407 },
		unique_name = { old = "baseballcap", new = "baseballcap" },
		id = { old = 36, new = 36 },
	},*/
	[54] = {
		hash = { old = 14182, new = 14182 },
		unique_name = { old = "toadhat", new = "toadhat" },
		id = { old = 49, new = 56 },
	},
	[55] = {
		hash = { old = 14218, new = 6758 },
		unique_name = { old = "servbot", new = "servbothead" },
		id = { old = 55, new = 55 },
	},
	[56] = {
		hash = { old = 5020, new = 5020 },
		unique_name = { old = "pumpkinhat", new = "pumpkinhat" },
		id = { old = 78, new = 30 },
	},
	[57] = {
		hash = { old = 54205, new = 54205 },
		unique_name = { old = "makarmask", new = "makarmask" },
		id = { old = 51, new = 52 },
	},
	[58] = {
		hash = { old = 27334, new = 27358 },
		unique_name = { old = "mariocap", new = "mariohat" },
		id = { old = 45, new = 51 },
	},
	[59] = {
		hash = { old = 52848, new = 52848 },
		unique_name = { old = "keatonmask", new = "keatonmask" },
		id = { old = 37, new = 48 },
	},
	[60] = {
		hash = { old = 12599, new = 26232 },
		unique_name = { old = "typicalglasses", new = "TypicalGlasses" },
		id = { old = 57, new = 58 },
	},
	[61] = {
		hash = { old = 40221, new = 40221 },
		unique_name = { old = "3dglasseshat", new = "3dglasseshat" },
		id = { old = 23, new = 22 },
	},
	[62] = {
		hash = { old = 13390, new = 1275 },
		unique_name = { old = "magehat", new = "blackmage_hat" },
		id = { old = 34, new = 44 },
	},
	[63] = {
		hash = { old = 34937, new = 34937 },
		unique_name = { old = "billyhatcher", new = "billyhatcher" },
		id = { old = 40, new = 43 },
	},
	[64] = {
		hash = { old = 27533, new = 47146 },
		unique_name = { old = "metamask", new = "metaknightmask" },
		id = { old = 41, new = 39 },
	},
	[65] = {
		hash = { old = 50272, new = 50272 },
		unique_name = { old = "headphones", new = "headphones" },
		id = { old = 48, new = 42 },
	},
	[66] = {
		hash = { old = 54882, new = 35616 },
		unique_name = { old = "joehelmet", new = "ViewtifulJoeHelmet" },
		id = { old = 50, new = 57 },
	},
}

local function getbyhash( hash_old )
    for _, v in ipairs( LegacyTranslation ) do
        if v.hash.old == hash_old then
            return v
        end
    end

    return nil
end

local function getbyid( id_old )
    for _, v in ipairs( LegacyTranslation ) do
        if v.id.old == id_old then
            return v
        end
    end

    return nil
end

function UpdateLegacy()

    LogPrint( "Translating legacy hats in SQL...", nil, "Hats" )

    local db = SQL.getDB()

    local query = db:query("SELECT id, hat, faceHat, HEX(levels) as levels FROM gm_users")
    function query:onSuccess(data)
        
        local temp_users = {}

        for _, v in ipairs(data) do
            local new = {}
            new.id = v.id

            GTowerStore:UpdateInventoryData( new, v.levels )
			
            new.hat = tonumber( v.hat ) or 0
            new.face_hat = tonumber( v.faceHat ) or 0

            table.insert( temp_users, new )
        end

        local transaction = db:createTransaction()

        for k, user in pairs( temp_users ) do
            for hash, level in pairs( user.GTowerLevels ) do
                local trans = getbyhash( hash )

                if trans and trans.hash.new != hash then
                    temp_users[k].GTowerLevels[ trans.hash.new ] = level
                    temp_users[k].GTowerLevels[ hash ] = nil

					if temp_users[k].GTowerMaxLevels[ hash ] then
						temp_users[k].GTowerMaxLevels[ trans.hash.new ] = temp_users[k].GTowerMaxLevels[ hash ]
						temp_users[k].GTowerMaxLevels[ hash ] = nil
					end

                    user.updated = true
                end
            end

            local hat = getbyid( user.hat )
            local face_hat = getbyid( user.face_hat )

            if hat and hat.id.new != user.hat then
                temp_users[k].hat = hat.id.new
                
                //print( "hat", user.hat, hat.id.old, hat.id.new )
                user.updated = true
            end

            if face_hat and face_hat.id.new != user.face_hat then
                temp_users[k].face_hat = face_hat.id.new

                //print( "face_hat", user.face_hat, face_hat.id.old, face_hat.id.new )
                user.updated = true
            end
        end

        for _, user in pairs( temp_users ) do
			if not user.updated then continue end

            local levels = GTowerStore:GetPlayerData( user )

            local q = db:prepare(Format("UPDATE gm_users SET levels=%s, hat=?, faceHat=? WHERE id = ?", levels))
            //q:setNumber(1, tonumber( levels ))
            q:setString(1, tostring( user.hat ))
            q:setNumber(2, user.face_hat)
            q:setString(3, tostring( user.id ))

            transaction:addQuery(q)
        end

        function transaction:onError(err)
            LogPrint( "An error occured while translating legacy hats (transaction): " .. err, color_red, "Hats" )
        end
    
        function transaction:onSuccess()
            LogPrint( "Successfully made transaction, legacy hats updated!", color_green, "Hats" )
        end
    
        transaction:start()

    end

    function query:onError(err)
        LogPrint( "An error occured while translating legacy hats: " .. err, color_red, "Hats" )
    end

    query:start()

end